<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persona Generator - AI-Powered Customer Insights</title>
    <meta name="description" content="Generate data-driven customer personas and chat with them to understand your target audience">
    <style>
        :root {
            --primary-50: #e3f2fd;
            --primary-100: #bbdefb;
            --primary-200: #90caf9;
            --primary-300: #64b5f6;
            --primary-400: #42a5f5;
            --primary-500: #2196f3;
            --primary-600: #1e88e5;
            --primary-700: #1976d2;
            --primary-800: #1565c0;
            --primary-900: #0d47a1;

            --neutral-50: #fafafa;
            --neutral-100: #f5f5f5;
            --neutral-200: #eeeeee;
            --neutral-300: #e0e0e0;
            --neutral-400: #bdbdbd;
            --neutral-500: #9e9e9e;
            --neutral-600: #757575;
            --neutral-700: #616161;
            --neutral-800: #424242;
            --neutral-900: #212121;

            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);

            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --radius-xl: 24px;

            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-2xl: 48px;
            --spacing-3xl: 64px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'SF Pro Display', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            padding: var(--spacing-lg);
            line-height: 1.6;
            color: var(--neutral-900);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .app-container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--spacing-2xl) var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--shadow-xl);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-600), var(--primary-400), #f093fb);
        }

        .header-title {
            font-size: clamp(28px, 5vw, 42px);
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-700), var(--primary-500));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--spacing-sm);
            letter-spacing: -0.5px;
        }

        .header-subtitle {
            font-size: clamp(16px, 2vw, 18px);
            color: var(--neutral-600);
            font-weight: 400;
        }

        .progress-bar-container {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--shadow-lg);
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            margin-bottom: var(--spacing-sm);
        }

        .progress-line {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--neutral-200);
            z-index: 0;
        }

        .progress-line-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-600), var(--primary-400));
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 3px;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1;
            flex: 1;
            position: relative;
        }

        .progress-step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: 3px solid var(--neutral-300);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--neutral-400);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: var(--spacing-sm);
        }

        .progress-step.active .progress-step-circle {
            background: linear-gradient(135deg, var(--primary-600), var(--primary-400));
            border-color: var(--primary-600);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }

        .progress-step.completed .progress-step-circle {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .progress-step-circle::after {
            content: '✓';
            opacity: 0;
            transition: opacity 0.3s;
        }

        .progress-step.completed .progress-step-circle::after {
            opacity: 1;
        }

        .progress-step.completed .progress-step-number {
            display: none;
        }

        .progress-step-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--neutral-600);
            text-align: center;
            transition: color 0.3s;
        }

        .progress-step.active .progress-step-label {
            color: var(--primary-700);
        }

        .content-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--spacing-2xl);
            box-shadow: var(--shadow-xl);
            margin-bottom: var(--spacing-xl);
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.5s ease-out forwards;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-header {
            margin-bottom: var(--spacing-xl);
        }

        .section-title {
            font-size: clamp(24px, 3vw, 32px);
            font-weight: 700;
            color: var(--neutral-900);
            margin-bottom: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .section-emoji {
            font-size: 32px;
        }

        .section-description {
            color: var(--neutral-600);
            font-size: 16px;
            line-height: 1.6;
        }

        .input-group {
            margin-bottom: var(--spacing-lg);
        }

        .input-label {
            display: block;
            font-weight: 600;
            color: var(--neutral-700);
            margin-bottom: var(--spacing-sm);
            font-size: 15px;
        }

        .input-textarea {
            width: 100%;
            padding: var(--spacing-md);
            border: 2px solid var(--neutral-300);
            border-radius: var(--radius-md);
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: all 0.2s;
            background: var(--neutral-50);
            line-height: 1.6;
        }

        .input-textarea:hover {
            border-color: var(--neutral-400);
            background: white;
        }

        .input-textarea:focus {
            outline: none;
            border-color: var(--primary-500);
            background: white;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .input-hint {
            font-size: 14px;
            color: var(--neutral-500);
            margin-top: var(--spacing-sm);
        }

        .btn {
            background: linear-gradient(135deg, var(--primary-600), var(--primary-500));
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: var(--radius-md);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-md);
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-icon {
            font-size: 18px;
        }

        .clusters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: var(--spacing-lg);
            margin-top: var(--spacing-xl);
        }

        .cluster-card {
            background: white;
            border: 2px solid var(--neutral-200);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .cluster-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-500), var(--primary-300));
            transform: scaleX(0);
            transition: transform 0.3s;
        }

        .cluster-card:hover {
            border-color: var(--primary-400);
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .cluster-card:hover::before {
            transform: scaleX(1);
        }

        .cluster-card.selected {
            border-color: var(--primary-500);
            background: linear-gradient(135deg, var(--primary-50), white);
            box-shadow: var(--shadow-lg);
        }

        .cluster-card.selected::before {
            transform: scaleX(1);
        }

        .cluster-header {
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .cluster-icon {
            font-size: 36px;
            line-height: 1;
            flex-shrink: 0;
        }

        .cluster-info {
            flex: 1;
            min-width: 0;
        }

        .cluster-title {
            font-size: 17px;
            font-weight: 700;
            color: var(--neutral-900);
            margin-bottom: var(--spacing-xs);
            line-height: 1.4;
        }

        .cluster-size {
            font-size: 14px;
            color: var(--neutral-600);
            font-weight: 500;
        }

        .cluster-traits {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        .trait-tag {
            background: var(--primary-50);
            color: var(--primary-700);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            border: 1px solid var(--primary-200);
        }

        .cluster-description {
            color: var(--neutral-700);
            font-size: 14px;
            line-height: 1.6;
        }

        .personas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--spacing-lg);
            margin-top: var(--spacing-xl);
        }

        .persona-card {
            background: white;
            border: 2px solid var(--neutral-200);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .persona-card::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: var(--radius-lg);
            padding: 2px;
            background: linear-gradient(135deg, var(--primary-500), var(--primary-300));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .persona-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .persona-card:hover::after {
            opacity: 1;
        }

        .persona-card.selected {
            background: linear-gradient(135deg, var(--primary-50), white);
            box-shadow: var(--shadow-lg);
        }

        .persona-card.selected::after {
            opacity: 1;
        }

        .persona-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-500), var(--primary-300));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: var(--spacing-md);
        }

        .persona-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--neutral-900);
            margin-bottom: var(--spacing-xs);
        }

        .persona-demographics {
            font-size: 14px;
            color: var(--neutral-600);
            margin-bottom: var(--spacing-md);
        }

        .persona-details {
            margin-bottom: var(--spacing-md);
        }

        .persona-detail {
            background: var(--neutral-50);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-sm);
            font-size: 13px;
            color: var(--neutral-700);
            margin-bottom: var(--spacing-sm);
            border-left: 3px solid var(--primary-400);
        }

        .persona-meta {
            font-size: 12px;
            color: var(--neutral-500);
            padding-top: var(--spacing-md);
            border-top: 1px solid var(--neutral-200);
        }

        .chat-container {
            background: var(--neutral-50);
            border: 2px solid var(--neutral-200);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            margin-top: var(--spacing-xl);
        }

        .chat-banner {
            background: linear-gradient(135deg, var(--primary-50), white);
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-lg);
            border-left: 4px solid var(--primary-500);
        }

        .chat-banner-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--neutral-900);
            margin-bottom: var(--spacing-xs);
        }

        .chat-banner-subtitle {
            font-size: 14px;
            color: var(--neutral-600);
        }

        .chat-messages {
            height: 480px;
            overflow-y: auto;
            background: white;
            border: 2px solid var(--neutral-200);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            scroll-behavior: smooth;
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: var(--neutral-100);
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--neutral-400);
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: var(--neutral-500);
        }

        .message {
            margin-bottom: var(--spacing-lg);
            display: flex;
            gap: var(--spacing-md);
            animation: messageSlideIn 0.3s ease-out;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, var(--primary-600), var(--primary-400));
        }

        .message.persona .message-avatar {
            background: var(--neutral-200);
        }

        .message-content {
            flex: 1;
            max-width: 75%;
        }

        .message-bubble {
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-md);
            line-height: 1.6;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, var(--primary-600), var(--primary-500));
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.persona .message-bubble {
            background: var(--neutral-100);
            color: var(--neutral-900);
            border-bottom-left-radius: 4px;
            border: 1px solid var(--neutral-200);
        }

        .message-header {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
            opacity: 0.7;
        }

        .chat-input-group {
            display: flex;
            gap: var(--spacing-md);
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            padding: var(--spacing-md) var(--spacing-lg);
            border: 2px solid var(--neutral-300);
            border-radius: var(--radius-md);
            font-size: 15px;
            font-family: inherit;
            transition: all 0.2s;
            background: white;
            resize: none;
            min-height: 52px;
            max-height: 120px;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .loading-container {
            text-align: center;
            padding: var(--spacing-3xl);
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--neutral-200);
            border-top-color: var(--primary-500);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--spacing-lg);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--neutral-600);
            font-size: 16px;
            font-weight: 500;
        }

        .error-message {
            background: #fef2f2;
            color: #991b1b;
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            border-left: 4px solid var(--error);
            margin: var(--spacing-lg) 0;
        }

        .meta-info {
            background: var(--primary-50);
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            margin-top: var(--spacing-lg);
            font-size: 14px;
            color: var(--neutral-700);
            border-left: 4px solid var(--primary-500);
        }

        .meta-info strong {
            color: var(--neutral-900);
            font-weight: 600;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 1024px) {
            .clusters-grid,
            .personas-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }
        }

        @media (max-width: 768px) {
            :root {
                --spacing-lg: 16px;
                --spacing-xl: 24px;
                --spacing-2xl: 32px;
            }

            body {
                padding: var(--spacing-md);
            }

            .header {
                padding: var(--spacing-xl) var(--spacing-lg);
            }

            .content-card {
                padding: var(--spacing-lg);
            }

            .progress-steps {
                flex-wrap: wrap;
            }

            .progress-step {
                flex: 0 0 50%;
                margin-bottom: var(--spacing-lg);
            }

            .progress-line {
                display: none;
            }

            .clusters-grid,
            .personas-grid {
                grid-template-columns: 1fr;
            }

            .chat-input-group {
                flex-direction: column;
            }

            .message-content {
                max-width: 85%;
            }

            .chat-messages {
                height: 360px;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <h1 class="header-title">Dynamic Persona Generator</h1>
            <p class="header-subtitle">AI-powered customer segmentation and persona insights</p>
        </header>

        <div class="progress-bar-container">
            <div class="progress-steps">
                <div class="progress-line">
                    <div class="progress-line-fill" id="progressFill" style="width: 25%"></div>
                </div>
                <div class="progress-step active" id="progressStep1">
                    <div class="progress-step-circle">
                        <span class="progress-step-number">1</span>
                    </div>
                    <span class="progress-step-label">Define Goal</span>
                </div>
                <div class="progress-step" id="progressStep2">
                    <div class="progress-step-circle">
                        <span class="progress-step-number">2</span>
                    </div>
                    <span class="progress-step-label">Select Cluster</span>
                </div>
                <div class="progress-step" id="progressStep3">
                    <div class="progress-step-circle">
                        <span class="progress-step-number">3</span>
                    </div>
                    <span class="progress-step-label">Choose Persona</span>
                </div>
                <div class="progress-step" id="progressStep4">
                    <div class="progress-step-circle">
                        <span class="progress-step-number">4</span>
                    </div>
                    <span class="progress-step-label">Chat & Learn</span>
                </div>
            </div>
        </div>

        <div id="step1" class="content-card">
            <div class="section-header">
                <h2 class="section-title">
                    <span class="section-emoji">🎯</span>
                    Define Your Goal
                </h2>
                <p class="section-description">
                    Describe your target audience or business objective. The more specific you are, the better your personas will be.
                </p>
            </div>
            <div class="input-group">
                <label class="input-label" for="goal">What's your business goal or target audience?</label>
                <textarea
                    id="goal"
                    class="input-textarea"
                    rows="5"
                    placeholder="Example: Increase Bose headphone adoption among college students in tier-2 cities&#10;&#10;Or try:&#10;• Budget-conscious commuters who value privacy&#10;• Tech enthusiasts in metro areas aged 25-35&#10;• Premium buyers willing to pay for quality"
                ></textarea>
                <p class="input-hint">Tip: Include demographics, behaviors, or pain points for better results</p>
            </div>
            <button class="btn" onclick="generateClusters()">
                <span class="btn-icon">✨</span>
                Generate Personas
            </button>
        </div>

        <div id="step2" class="content-card hidden">
            <div class="section-header">
                <h2 class="section-title">
                    <span class="section-emoji">📊</span>
                    Select a Cluster
                </h2>
                <p class="section-description">
                    We've identified distinct audience segments. Click on a cluster to explore detailed personas.
                </p>
            </div>
            <div id="clusters-container"></div>
        </div>

        <div id="step3" class="content-card hidden">
            <div class="section-header">
                <h2 class="section-title">
                    <span class="section-emoji">👥</span>
                    Choose a Persona
                </h2>
                <p class="section-description">
                    Each persona represents a unique customer profile. Select one to start a conversation.
                </p>
            </div>
            <div id="personas-container"></div>
        </div>

        <div id="step4" class="content-card hidden">
            <div class="section-header">
                <h2 class="section-title">
                    <span class="section-emoji">💬</span>
                    Chat with Persona
                </h2>
                <p class="section-description">
                    Ask questions to understand their needs, preferences, and pain points.
                </p>
            </div>
            <div class="chat-container">
                <div class="chat-banner" id="personaBanner">
                    <h3 class="chat-banner-title">Start Your Conversation</h3>
                    <p class="chat-banner-subtitle">Ask about pricing, features, concerns, or preferences</p>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <div class="message persona">
                        <div class="message-avatar">👋</div>
                        <div class="message-content">
                            <div class="message-bubble">
                                Hello! I'm ready to share my thoughts about your product. What would you like to know?
                            </div>
                        </div>
                    </div>
                </div>
                <div class="chat-input-group">
                    <textarea
                        id="chatInput"
                        class="chat-input"
                        placeholder="Type your message here..."
                        rows="1"
                    ></textarea>
                    <button class="btn" onclick="sendMessage()">
                        <span class="btn-icon">📤</span>
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Auto-detect API base URL
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const PRODUCTION_API = 'https://dyn-personas-656907085987.asia-south1.run.app';
        const API_BASE = isLocal ? window.location.origin : PRODUCTION_API;

        let currentClusters = [];
        let currentPersonas = [];
        let selectedClusterId = null;
        let selectedPersonaId = null;
        let selectedPersonaName = '';
        let conversationHistory = [];
        let currentGoal = '';
        let currentStep = 1;

        function updateProgressBar(step) {
            currentStep = step;
            const progress = (step / 4) * 100;
            document.getElementById('progressFill').style.width = progress + '%';

            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById(`progressStep${i}`);
                stepEl.classList.remove('active', 'completed');
                if (i < step) stepEl.classList.add('completed');
                if (i === step) stepEl.classList.add('active');
            }
        }

        function showStep(stepId) {
            document.querySelectorAll('.content-card').forEach(card => {
                card.classList.add('hidden');
            });
            document.getElementById(stepId).classList.remove('hidden');

            const stepNum = parseInt(stepId.replace('step', ''));
            updateProgressBar(stepNum);

            document.getElementById(stepId).scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        async function generateClusters() {
            const goal = document.getElementById('goal').value.trim();
            if (!goal) {
                alert('Please enter a goal or target audience description');
                return;
            }

            currentGoal = goal;

            try {
                showStep('step2');
                document.getElementById('clusters-container').innerHTML = `
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Analyzing audience and generating clusters...</div>
                    </div>
                `;

                const response = await fetch(`${API_BASE}/clusters/generate`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        goal: goal,
                        k_min: 2,
                        k_max: 4,
                        detailed_personas: true
                    })
                });

                const data = await response.json();

                if (data.clusters && data.clusters.length > 0) {
                    currentClusters = data.clusters;
                    displayClusters(data.clusters, data.meta);
                } else {
                    document.getElementById('clusters-container').innerHTML = `
                        <div class="error-message">
                            No clusters found. Try adjusting your goal or target audience description.
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error generating clusters:', error);
                document.getElementById('clusters-container').innerHTML = `
                    <div class="error-message">
                        Error connecting to API. Please ensure the server is running.
                    </div>
                `;
            }
        }

        function displayClusters(clusters, meta) {
            const container = document.getElementById('clusters-container');

            let html = '<div class="clusters-grid">';

            clusters.forEach(cluster => {
                html += `
                    <div class="cluster-card" onclick="selectCluster(${cluster.cluster_id})">
                        <div class="cluster-header">
                            <div class="cluster-icon">${cluster.representative_icon}</div>
                            <div class="cluster-info">
                                <div class="cluster-title">${cluster.cluster_label}</div>
                                <div class="cluster-size">${cluster.cluster_size_pct}% of audience • ${cluster.cluster_size.toLocaleString()} users</div>
                            </div>
                        </div>
                        <div class="cluster-traits">
                            ${cluster.top_traits.map(trait => `<span class="trait-tag">${trait}</span>`).join('')}
                        </div>
                        <div class="cluster-description">${cluster.cluster_description}</div>
                    </div>
                `;
            });

            html += '</div>';

            if (meta) {
                html += `<div class="meta-info">
                    <strong>Analysis Summary:</strong>
                    Analyzed ${meta.subset_n.toLocaleString()} users •
                    Generated ${meta.k} clusters •
                    Silhouette score: ${meta.silhouette} •
                    ${Object.keys(meta.filters_applied).length} filters applied
                </div>`;
            }

            container.innerHTML = html;
        }

        async function selectCluster(clusterId) {
            selectedClusterId = clusterId;

            document.querySelectorAll('.cluster-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.cluster-card').classList.add('selected');

            await loadPersonas(clusterId);
        }

        async function loadPersonas(clusterId) {
            try {
                showStep('step3');
                document.getElementById('personas-container').innerHTML = `
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Generating personas for selected cluster...</div>
                    </div>
                `;

                const response = await fetch(`${API_BASE}/personas/${clusterId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        goal: currentGoal,
                        k_min: 2,
                        k_max: 4,
                        detailed_personas: true
                    })
                });

                const data = await response.json();

                if (data.personas && data.personas.length > 0) {
                    currentPersonas = data.personas;
                    displayPersonas(data.personas, data.cluster_info);
                } else {
                    document.getElementById('personas-container').innerHTML = `
                        <div class="error-message">No personas generated for this cluster.</div>
                    `;
                }
            } catch (error) {
                console.error('Error loading personas:', error);
                document.getElementById('personas-container').innerHTML = `
                    <div class="error-message">Error loading personas. Please try again.</div>
                `;
            }
        }

        function displayPersonas(personas, clusterInfo) {
            const container = document.getElementById('personas-container');

            let html = '<div class="personas-grid">';

            personas.forEach(persona => {
                const initials = persona.persona_name.split(' ').map(n => n[0]).join('').slice(0, 2);
                html += `
                    <div class="persona-card" onclick="selectPersona('${persona.persona_id}', '${escapeHtml(persona.persona_name)}')">
                        <div class="persona-avatar">${initials}</div>
                        <div class="persona-name">${persona.persona_name}</div>
                        <div class="persona-demographics">${persona.demographics}</div>
                        <div class="persona-details">
                            ${persona.care_about_top2.map(care =>
                                `<div class="persona-detail">✓ ${care}</div>`
                            ).join('')}
                            <div class="persona-detail">⚠ ${persona.barriers_top1}</div>
                        </div>
                        <div class="persona-meta">
                            Media: ${persona.media_preference} • Score: ${persona.behavioral_score}
                        </div>
                    </div>
                `;
            });

            html += '</div>';

            if (clusterInfo) {
                html += `<div class="meta-info">
                    <strong>Cluster ${clusterInfo.cluster_id}:</strong>
                    ${clusterInfo.cluster_label} •
                    ${clusterInfo.cluster_size.toLocaleString()} users in this segment
                </div>`;
            }

            container.innerHTML = html;
        }

        function selectPersona(personaId, personaName) {
            selectedPersonaId = personaId;
            selectedPersonaName = personaName;

            document.querySelectorAll('.persona-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.persona-card').classList.add('selected');

            startChat(personaName);
        }

        function startChat(personaName) {
            showStep('step4');
            conversationHistory = [];

            document.getElementById('personaBanner').innerHTML = `
                <h3 class="chat-banner-title">Chatting with ${personaName}</h3>
                <p class="chat-banner-subtitle">Ask about their needs, preferences, and concerns</p>
            `;

            document.getElementById('chatMessages').innerHTML = `
                <div class="message persona">
                    <div class="message-avatar">👋</div>
                    <div class="message-content">
                        <div class="message-bubble">
                            Hello! I'm ready to share my thoughts about your product. What would you like to know?
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('chatInput').value = '';
            document.getElementById('chatInput').focus();
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message || !selectedPersonaId) return;

            addMessageToChat('user', message);
            input.value = '';

            const sendBtn = event.target;
            const originalText = sendBtn.innerHTML;
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="btn-icon">⏳</span> Sending...';

            try {
                const response = await fetch(`${API_BASE}/personas/${selectedPersonaId}/chat`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        cluster_id: selectedClusterId,
                        persona_id: selectedPersonaId,
                        message: message,
                        conversation_history: conversationHistory
                    })
                });

                const data = await response.json();

                addMessageToChat('persona', data.response);
                conversationHistory = data.conversation_history || [];

            } catch (error) {
                console.error('Error sending message:', error);
                addMessageToChat('persona', 'Sorry, I encountered an error. Please try again.');
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = originalText;
            }
        }

        function addMessageToChat(sender, text) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const avatar = sender === 'user' ? '👤' : '🤖';

            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    <div class="message-bubble">${escapeHtml(text)}</div>
                </div>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Auto-expand chat textarea
        document.getElementById('chatInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Enter to send (Shift+Enter for new line)
        document.getElementById('chatInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        console.log('%c🎨 Dynamic Persona Generator', 'color: #1976d2; font-size: 20px; font-weight: bold;');
        console.log('API Base:', API_BASE);
    </script>
</body>
</html>
